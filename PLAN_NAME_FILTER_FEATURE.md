# 主体报表计划名称过滤功能

## 功能概述

本功能为主体报表导入添加了智能过滤功能，只保留计划名称包含指定关键字的数据行，提高数据导入的精准度。

## 功能详情

### 过滤规则
- **过滤字段**: 计划名称（或推广计划）
- **过滤关键字**: 
  - 五更
  - 希臻
  - 谦易律哲

### 过滤逻辑
1. 系统会自动识别Excel/CSV文件中的"计划名称"或"推广计划"列
2. 对每一行数据，检查计划名称是否包含任何一个指定关键字
3. 只有包含关键字的行才会被导入到数据库中
4. 如果没有找到计划名称列，则导入所有数据（保持向后兼容性）

## 技术实现

### 数据库更改
- 在 `subject_report` 表中新增 `plan_name` 字段
- 字段类型: VARCHAR(200)
- 用于存储计划名称信息

### 代码更改
1. **列名映射**: 在 `get_subject_report_column_mapping()` 函数中添加了对"计划名称"和"推广计划"列的识别
2. **过滤逻辑**: 在 `process_subject_report_file()` 函数中添加了基于关键字的过滤逻辑
3. **数据存储**: 在 `SubjectReport` 模型中添加了 `plan_name` 字段

### 过滤流程
```
读取Excel/CSV文件
    ↓
识别计划名称列
    ↓
遍历每一行数据
    ↓
检查计划名称是否包含关键字
    ↓
[包含] → 导入数据库
[不包含] → 跳过该行
```

## 部署方式

### Windows 系统
```bash
deploy_plan_name_filter.bat
```

### Linux 系统
```bash
chmod +x deploy_plan_name_filter.sh
./deploy_plan_name_filter.sh
```

### 手动部署
1. 运行数据库迁移：
   ```bash
   python migrate_plan_name.py
   ```

2. 重启后端服务：
   ```bash
   docker-compose restart backend
   ```

## 使用效果

### 导入前
- 假设Excel文件有1000行数据
- 包含各种不同的计划名称

### 导入后
- 只导入计划名称包含"五更"、"希臻"、"谦易律哲"的行
- 大幅减少无关数据的导入
- 提高数据查询和分析的效率

## 兼容性

- **向后兼容**: 如果文件中没有计划名称列，系统会导入所有数据
- **多格式支持**: 支持 .xlsx、.xls、.csv 格式
- **编码支持**: 自动检测多种文件编码

## 注意事项

1. 关键字匹配区分大小写
2. 只要包含任何一个关键字即可通过过滤
3. 过滤是基于包含关系，而不是完全匹配
4. 建议在测试环境中先验证过滤效果

## 日志信息

系统会在控制台输出详细的过滤信息：
- 识别到的计划名称列
- 过滤的关键字
- 跳过的行数
- 最终导入的行数

这有助于用户了解过滤过程和结果。 