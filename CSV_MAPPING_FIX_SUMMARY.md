# 主体报表CSV列名映射修复总结

## 问题描述

用户反映主体报表CSV文件的列名与数据库字段对应不上，导致数据无法正确导入。

## 问题分析

1. **映射逻辑过于简单**: 原有的列名映射函数只支持少数几个关键词，无法覆盖实际CSV文件中的列名变体
2. **缺少调试信息**: 没有详细的调试信息来帮助排查映射问题
3. **关键词不够全面**: 没有考虑到不同平台、不同格式的CSV文件可能使用的不同术语

## 解决方案

### 1. 改进列名映射逻辑

**原有逻辑**:
```python
if '商品名称' in col or '产品名称' in col:
    mapping['product_name'] = col
```

**改进后逻辑**:
```python
if any(keyword in col_clean for keyword in ['商品名称', '产品名称', '商品标题', '宝贝标题']):
    mapping['product_name'] = col
```

### 2. 扩展关键词覆盖范围

为每个数据库字段添加了更多的关键词变体：

#### 基础字段
- `product_name`: 商品名称, 产品名称, 商品标题, 宝贝标题
- `product_code`: 商品编码, 产品编码, 商品代码, 产品代码, id
- `plan_name`: 计划名称, 推广计划, 计划, 广告计划

#### 推广数据
- `promotion_cost`: 推广费, 广告费, 推广费用, 广告费用, 推广成本, 广告成本
- `promotion_clicks`: 点击量, 点击数, 点击次数
- `promotion_impressions`: 展现量, 展现数, 展现次数, 曝光量, 曝光数
- `promotion_ctr`: 点击率, CTR, ctr
- `promotion_cpc`: 点击单价, CPC, cpc, 平均点击花费

#### 销售数据
- `sales_amount`: 销售金额, 销售额, 成交金额, 交易金额
- `sales_quantity`: 销售数量, 销量, 成交数量, 交易数量

### 3. 添加调试信息

在列名映射函数中添加了详细的调试信息：
```python
print(f"检测到的CSV列名: {columns}")
print(f"映射结果: {mapping}")
```

### 4. 新增计划名称过滤功能

添加了基于计划名称的数据过滤功能，只保留包含以下关键词的记录：
- 五更
- 希臻
- 谦易律哲

## 技术实现

### 1. 数据库更改
- 在 `subject_report` 表中新增 `plan_name` 字段
- 创建了数据库迁移脚本 `migrate_plan_name.py`

### 2. 代码更改
- 改进了 `get_subject_report_column_mapping()` 函数
- 在 `process_subject_report_file()` 函数中添加了过滤逻辑
- 更新了 `SubjectReport` 模型

### 3. 文档更新
- 创建了 `CSV_COLUMN_MAPPING.md` 详细说明映射规则
- 创建了 `PLAN_NAME_FILTER_FEATURE.md` 说明过滤功能

## 部署方式

### 自动部署
```bash
# Windows
deploy_csv_mapping_fix.bat

# Linux  
chmod +x deploy_plan_name_filter.sh
./deploy_plan_name_filter.sh
```

### 手动部署
1. 运行数据库迁移：
   ```bash
   python migrate_plan_name.py
   ```

2. 重启后端服务：
   ```bash
   docker-compose restart backend
   ```

## 测试验证

### 1. 上传测试
1. 准备包含各种列名变体的CSV文件
2. 上传到系统中
3. 查看控制台输出的调试信息
4. 检查数据库中的数据是否正确导入

### 2. 过滤测试
1. 准备包含不同计划名称的CSV文件
2. 上传后检查只有包含指定关键词的记录被导入
3. 验证过滤逻辑是否正确工作

## 预期效果

1. **提高兼容性**: 支持更多CSV文件格式和列名变体
2. **便于调试**: 通过控制台输出可以快速定位映射问题
3. **精确过滤**: 只导入需要的数据，避免无关数据污染
4. **维护友好**: 清晰的文档和代码结构便于后续维护

## 注意事项

1. **编码问题**: 确保CSV文件使用正确的中文编码
2. **列名准确**: 列名应该包含文档中列出的关键词
3. **过滤规则**: 了解计划名称过滤规则，确保数据包含必要的关键词
4. **调试信息**: 如有问题，请查看控制台输出的调试信息

## 后续优化建议

1. **动态配置**: 考虑将关键词配置外部化，便于不同客户定制
2. **智能识别**: 可以考虑使用机器学习来提高列名识别准确性
3. **用户反馈**: 收集用户使用反馈，持续优化映射逻辑
4. **性能优化**: 对于大文件，考虑分批处理以提高性能 