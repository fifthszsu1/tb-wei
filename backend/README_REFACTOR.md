# 后端重构说明

## 重构概述

本次重构将原来的单体 `app.py`（2772行）拆分为模块化的架构，提高了代码的可维护性和可扩展性。

## 新的目录结构

```
backend/
├── app.py                      # 主应用文件（简化后148行）
├── config.py                   # 配置管理
├── models.py                   # 数据库模型
├── utils.py                    # 工具函数
├── routes/                     # 路由模块
│   ├── __init__.py
│   ├── auth.py                 # 认证相关路由
│   ├── upload.py               # 文件上传路由
│   ├── data.py                 # 数据查询路由
│   └── business.py             # 业务计算路由
├── services/                   # 业务服务
│   ├── __init__.py
│   └── file_processor.py       # 文件处理服务
└── app_old.py                  # 原始文件备份
```

## 模块说明

### 1. 配置模块 (config.py)
- 统一管理应用配置
- 支持多环境配置（开发、生产、测试）
- 配置类继承，便于扩展

### 2. 数据模型 (models.py)
- 包含所有SQLAlchemy模型
- 用户认证相关模型
- 业务数据模型

### 3. 工具函数 (utils.py)
- 数据处理工具函数
- 文件读取和解析工具
- 数据验证和转换函数

### 4. 路由模块 (routes/)
#### auth.py - 认证路由
- 用户注册和登录
- 用户信息获取
- 用户统计信息

#### upload.py - 文件上传路由
- 产品数据上传
- 产品总表导入
- 种菜表格导入
- 主体报表导入

#### data.py - 数据查询路由
- 数据列表查询
- 数据导出
- 统计信息
- 基础数据查询

#### business.py - 业务计算路由
- 推广费用汇总计算
- 种菜数据汇总
- 最终业务数据计算

### 5. 业务服务 (services/)
#### file_processor.py - 文件处理服务
- 文件上传处理逻辑
- 数据解析和验证
- 数据库操作封装

## 重构优势

1. **模块化设计**：功能清晰分离，便于维护
2. **代码复用**：公共功能提取到utils和services
3. **职责分离**：路由只负责HTTP处理，业务逻辑在services
4. **配置管理**：统一的配置管理，支持多环境
5. **可测试性**：模块化结构便于单元测试
6. **可扩展性**：新功能可以独立添加新模块

## 使用方式

启动应用的方式保持不变：

```bash
python app.py
```

所有的API接口和功能都保持兼容，前端无需修改。

## 文件对比

- **重构前**：app.py (2772行) - 所有功能混在一起
- **重构后**：
  - app.py (148行) - 应用初始化和配置
  - 功能模块分布在不同文件中
  - 总代码量相同，但结构更清晰

## 注意事项

1. 原始的 `app.py` 已备份为 `app_old.py`
2. 如果需要回滚，可以将 `app_old.py` 重命名为 `app.py`
3. 新的模块化结构需要确保所有依赖文件都在正确位置 